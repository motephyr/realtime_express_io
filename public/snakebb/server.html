<!DOCTYPE html>
<html>
<head>
  <!-- Load the Paper.js library -->
  <script src="/bower_components/jquery/dist/jquery.min.js"></script>
  <script src="/bower_components/paper/dist/paper-full.min.js"></script>
  <!-- Define inlined PaperScript associate it with myCanvas -->
  <script type="text/paperscript" canvas="myCanvas">

    var keyWords = "我愛布朗尼"
    var notkeyWords = "JOFDSAFDSF"
    var boom = "炸"

    function randomInt(min,max) {
      return Math.floor(Math.random()*(max-min+1)+min);
    }

    var Food = function(center,words){
      this.obj = new PointText(new Point(0, 0));
      this.obj.content = words[randomInt(0,words.length-1)];
      this.obj.position = center;
    }

    var createFood = function(words){
      var food = new Food([Math.round(Math.random()*view.bounds.right/10)*10, Math.round(Math.random()*view.bounds.height/10)*10],words);

      
      return food;
    }

    var bound = {
      x1: 0,
      x2: 300,
      y1: 0,
      y2: 150
    };

    function Background(b){
      var path = new Path();
      // Give the stroke a color
      path.style = {
        strokeColor: 'black',
        strokeWidth: 10,
      };
      var start = new Point(0, 0);
      // Move to start and draw a line from there
      path.moveTo(start);
      // Note the plus operator on Point objects.
      // PaperScript does that for us, and much more!
      path.lineTo(start + [ b.x1, b.y2 ]);
      path.lineTo(start + [ b.x2, b.y2 ]);
      path.lineTo(start + [ b.x2, b.y1 ]);
      path.lineTo(start + [ -b.x2, b.y1]);
    }
    new Background(bound);

    var Snake = function(){
      this.path = new Path();
      this.path.style = {
        strokeColor: '#E4141B',
        strokeWidth: 10,
        strokeCap: 'square'
      };


      this.string = "我";
      this.size = this.string.length;
      // this.segments = this.path.segments;
      this.start = view.center / [10, 1];

      this.point = this.start;
      this.direction = [0, 10];
      this.newDirection = this.direction;
      this.text = [];


      // start
      for (var i = 0; i < this.size; i++) {

        this.path.add(new Point(1 * 10, 0));
      }

    }

    Snake.prototype = {
      changeDirection: function(){
        if (keyState['up']  === true){
          if (this.direction[1] != 10) { // not down
            this.newDirection = [0, -10];
          }
        }else if (keyState['down'] === true){
          if (this.direction[1] != -10) {
            this.newDirection = [0, 10];
          }
        }else if(keyState['left']  === true){
          if (this.direction[0] != 10) {
            this.newDirection = [-10, 0];
          }
        }else if(keyState['right'] === true){
          if (this.direction[0] != -10) {
            this.newDirection = [10, 0];
          }
        }
        this.direction = this.newDirection;
      },
      changeDirection2: function(){
        if (keyState['w'] === true){
          if (this.direction[1] != 10) { // not down
            this.newDirection = [0, -10];
          }
        }else if (keyState['s'] === true){
          if (this.direction[1] != -10) {
            this.newDirection = [0, 10];
          }
        }else if(keyState['a'] === true){
          if (this.direction[0] != 10) {
            this.newDirection = [-10, 0];
          }
        }else if(keyState['d'] === true){
          if (this.direction[0] != -10) {
            this.newDirection = [10, 0];
          }
        }
        this.direction = this.newDirection;
      },

      move: function(){

        // console.log(this.segments);

        var oldSegments = this.path.segments.slice(0);
        var newSegments = [{point:oldSegments[0].point + this.direction}].concat(oldSegments.slice(0,oldSegments.length - 1));

        // console.log(oldSegments);
        // console.log(newPoint);

        // var previousPoint = new Point(this.segments[0].point);
        // this.segments[0].point = this.segments[0].point + this.direction;
        
        while (i = this.text.shift()){
          i.remove();
        }

        this.path.removeSegments();

        while(segs = newSegments.shift()){
          this.text.push(new PointText(segs.point.x - 5,segs.point.y + 5));
          this.path.add(new Point(segs.point));
        }

        for(var i = 0, len = this.text.length; i < len ;i++){
          this.text[i].content = this.string[i];
        }

        // for (var i = 1; i < this.size; i++) {

        //   this.changeTextStruct(i-1);

        //   var tempPoint = new Point(this.segments[i].point);
        //   this.segments[i].point = new Point(previousPoint.x, previousPoint.y);
        //   previousPoint = tempPoint;
        // }

        // this.changeTextStruct(this.size-1);
        return this.path.segments[0].point;
      },
      changeTextStruct: function(position){
        // var aa = new PointText(this.segments[position].point.x-5,this.segments[position].point.y+5);
        // aa.content = this.string[position];
        // this.text.push(aa);
      },
      addText: function(item){
        this.string = this.string + item.content;
        this.size = this.string.length;
        this.path.add(this.path.segments[this.size-2].point);

      },
      removeText: function(){
        var strlen = this.string.length;
        this.string = this.string.slice(0, strlen - 1);
        this.size = this.string.length;
        this.text[strlen - 1].remove();
        // console.log(this.string);
        this.path.removeSegment(strlen-1);
        // console.log(this.size);
      },
      remove:function(){
        for(;this.size;){
          this.removeText();
        }
        this.path.remove();
      }
    }


    var player1 = new Snake();
    var player2 = new Snake();

    var hitOptions = {
      segments: true,
      stroke: false,
      fill: true
    };
    var bodies = [];

    var count = 0;
    function onFrame(event) {

      count++;
      if (count%20===0){
        player1.changeDirection();
        player2.changeDirection2();
        if  (bodies.length < 5){
          bodies.push(createFood(keyWords));
          bodies.push(createFood(notkeyWords));
          bodies.push(createFood(boom));
          bodies.push(createFood(notkeyWords));
          bodies.push(createFood(notkeyWords));
        }

        // console.log(point);

        var point1 = player1.move();
        var point2 = player2.move();

        hasEat(player1, point1);
        hasEat(player2, point2);

        if(isTouchWall(point1)){
          player1.remove();
          player1 = new Snake();
        }
        if(isTouchWall(point2)){
          player2.remove();
          player2 = new Snake();
        }

        // console.log(player1);

      }
    }

    function hasEat(snake, point){
      for (var i=0;i<bodies.length;i++){
        var hitResult = bodies[i].obj.hitTest(point, hitOptions);
        if (hitResult){
          bodies.splice(i,1);
          if (keyWords.indexOf(hitResult.item.content) != -1){
            snake.addText(hitResult.item);
            bodies.push(createFood(keyWords));
          }else if(boom.indexOf(hitResult.item.content) != -1){
            snake.removeText();
            bodies.push(createFood(boom));
          }else{
            snake.addText(hitResult.item);
            bodies.push(createFood(notkeyWords));
          }
          hitResult.item.remove();
        }
      }
    }

    function isTouchWall(point){
      return (point.x <= bound.x1 || point.x >= bound.x2 || point.y <= bound.y1 || point.y >= bound.y2);
    }

    var keyState = {};


    function onKeyDown(event) {
      for(var k in keyState){
        keyState[k] = false;
      }
      keyState[event.key] = true;
    }
    // function onKeyUp(event) {
    //   keyState[event.key] = false;
    // }

    // var Manager = function(){
    //   this.currentIndex = -1;
    //   this.currentObject = null;
    //   this.repeat = true;
    //   this.items = [];
    // };

    // Manager.prototype.add = function(obj){
    //   this.items.push(obj);
    // };

    // Manager.prototype.doAnimation = function(){
    //   if(this.items.length){
    //     if(this.currentIndex == -1 || ){
    //       this.currentIndex = 0;
    //     }  
    //     this.currentObject = this.items[this.currentIndex];
    //   }
    // };

    var animateDefine = {
      startLeft: 20,
      endLeft: 240
    }

    var secondStamp = 0;

    var mobj = $(moonImg);
    var sobj = $(sunImg);

    setInterval(function(){

      if(secondStamp == 0){
        sobj.show();
        sobj.css({left:animateDefine.startLeft});
        sobj.animate({left:animateDefine.endLeft}, 40000);
      }else if(secondStamp == 40){
        sobj.stop();
        sobj.hide();

        mobj.show();
        mobj.css({left:animateDefine.startLeft});
        mobj.animate({left:animateDefine.endLeft}, 40000);
      }else if(secondStamp == 80){
        mobj.stop();
        mobj.hide();
      }

      if(secondStamp == 80){
        secondStamp = 0;
      }else{
        secondStamp++;  
      }

      // secondStamp = Math.ceil(secondStamp * 10) / 10;
      
      console.log(secondStamp);  
      
    },1000);

    



  </script>
</head>
<body>
  <div style="width:500px;height:500px;">
    <div style="height:300px;position:relative;">
      <img id="sunImg" src="sun.png" width="50" height="50" style="position:absolute;left:0px;top:10px;display:none;" />
      <img id="moonImg" src="moon.png" width="50" height="50" style="position:absolute;left:0px;top:30px;display:none;" />
    </div>
    <canvas id="myCanvas" resize></canvas>
  </div>
</body>
</html>